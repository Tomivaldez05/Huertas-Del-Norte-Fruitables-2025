<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Dashboard de Administración</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #191C24;
            --bg-secondary: #2C3E50;
            --bg-tertiary: #34495E;
            --text-primary: #ffffff;
            --text-secondary: #A0AEC0;
            --accent: #007bff;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            background-color: var(--bg-secondary);
            min-height: 100vh;
            padding: 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar .nav-link {
            color: var(--text-secondary);
            padding: 15px 20px;
            border-radius: 0;
            transition: all 0.3s;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: var(--accent);
            color: var(--text-primary);
        }

        .main-content {
            background-color: var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--bg-tertiary);
            color: var(--text-primary);
        }

        .card-header {
            background-color: var(--bg-tertiary);
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .form-control, .form-select {
            background-color: var(--bg-tertiary);
            border: 1px solid #4A5568;
            color: var(--text-primary);
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--bg-tertiary);
            border-color: var(--accent);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .form-control::placeholder {
            color: var(--text-secondary);
        }

        .btn-primary {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .btn-success {
            background-color: var(--success);
            border-color: var(--success);
        }

        .btn-danger {
            background-color: var(--danger);
            border-color: var(--danger);
        }

        .btn-warning {
            background-color: var(--warning);
            border-color: var(--warning);
            color: #000;
        }

        .table-dark {
            --bs-table-bg: var(--bg-secondary);
            --bs-table-striped-bg: var(--bg-tertiary);
        }

        .modal-content {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        .modal-header {
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .modal-footer {
            border-top: 1px solid var(--bg-tertiary);
        }

        .form-check-input:checked {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .navbar-brand {
            color: var(--text-primary) !important;
            font-weight: bold;
        }

        .permission-grid {
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--bg-tertiary);
            padding: 15px;
            border-radius: 5px;
        }

        .hidden {
            display: none;
        }
        
        .badge-modulo {
            background-color: #267c7c !important;
            color: white !important;
        }

        .crud-permissions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .crud-permission-item {
            background-color: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--bg-tertiary);
        }

	.text-muted {
	    color: #dcdee3 !important;
	}


    </style>
</head>

<body>
    <script>
        alert('Script de prueba - Página cargadaaaaaa');
        console.log('Script de prueba - Página cargadaaaaaaa');
    </script>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="navbar-brand">Admin Panel</h4>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showSection('perfiles')">
                                <i class="bi bi-people-fill me-2"></i>
                                Gestión de Perfiles
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('asignacion')">
                                <i class="bi bi-diagram-3-fill me-2"></i>
                                Asignar Permisos
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                
                <!-- Sección Perfiles -->
                <div id="perfiles" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-3">
                        <h1 class="h2">Gestión de Perfiles</h1>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#perfilModal" onclick="openPerfilModal()">
                            <i class="bi bi-plus-circle me-2"></i>Nuevo Perfil
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-dark table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Usuario</th>
                                            <th>Email</th>
                                            <th>Cargo</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="perfiles-table">
                                        <!-- Se llena dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección Asignación de Permisos -->
                <div id="asignacion" class="content-section hidden">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-3">
                        <h1 class="h2">Asignar Permisos a Perfiles</h1>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="perfil-select" class="form-label">Seleccionar Perfil</label>
                                    <select class="form-select" id="perfil-select" onchange="loadPerfilPermisos()">
                                        <option value="">Seleccione un perfil...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="modulo-select" class="form-label">Seleccionar Módulo</label>
                                    <select class="form-select" id="modulo-select" onchange="loadPerfilPermisos()">
                                        <option value="">Seleccione un módulo...</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="permisos-assignment" class="mt-4" style="display: none;">
                                <h5>Permisos CRUD para el Módulo Seleccionado</h5>
                                <div class="crud-permissions" id="crud-permissions">
                                    <!-- Se llena dinámicamente con permisos CRUD -->
                                </div>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-success" id="savePermisosBtn">
                                        <i class="bi bi-check-circle me-2"></i>Guardar Permisos
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gestión de Módulos -->
                <div id="modulos" class="content-section">
                    <!-- Contenido de la sección de gestión de módulos -->
                </div>

                <!-- Gestión de Permisos -->
                <div id="permisos" class="content-section">
                    <!-- Contenido de la sección de gestión de permisos -->
                </div>

            </main>
        </div>
    </div>

    <!-- Modal Perfil -->
    <div class="modal fade" id="perfilModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="perfilModalTitle">Nuevo Perfil</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="perfilForm">
                        <input type="hidden" id="perfil-id">
                        <div class="mb-3">
                            <label for="perfil-usuario" class="form-label">Usuario</label>
                            <input type="text" class="form-control" id="perfil-usuario" required>
                        </div>
                        <div class="mb-3">
                            <label for="perfil-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="perfil-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="perfil-password" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="perfil-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="perfil-cargo" class="form-label">Cargo</label>
                            <select class="form-select" id="perfil-cargo" required>
                                <option value="">Seleccione un cargo...</option>
                                <option value="Administrador">Administrador</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Operador">Operador</option>
                                <option value="Vendedor">Vendedor</option>
                                <option value="Cajero">Cajero</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="perfil-activo" checked>
                                <label class="form-check-label" for="perfil-activo">
                                    Perfil Activo
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="savePerfil()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // PRUEBA: Verifica que el JS se ejecuta
        alert('JS cargado correctamente');
        console.log('JS cargado correctamente');

        // Función para mostrar/ocultar secciones
        function showSection(sectionId) {
            console.log('Mostrando sección:', sectionId);
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Mostrar la sección seleccionada
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                selectedSection.style.display = 'block';
                console.log('Sección mostrada:', sectionId);

                // Si es la sección de asignación, cargar los selectores
                if (sectionId === 'asignacion') {
                    // Cargar perfiles
                    fetch('api_permisos.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action: 'get_perfiles'
                        })
                    })
                    .then(response => response.json())
                    .then(perfiles => {
                        console.log('Perfiles cargados:', perfiles);
                        const select = document.getElementById('perfil-select');
                        select.innerHTML = '<option value="">Seleccione un perfil</option>';
                        perfiles.forEach(perfil => {
                            const option = document.createElement('option');
                            option.value = perfil.id;
                            option.textContent = `${perfil.usuario} (${perfil.cargo})`;
                            select.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error cargando perfiles:', error);
                        alert('Error cargando perfiles: ' + error.message);
                    });

                    // Cargar módulos
                    fetch('api_permisos.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action: 'get_modulos'
                        })
                    })
                    .then(response => response.json())
                    .then(modulos => {
                        console.log('Módulos cargados:', modulos);
                        const select = document.getElementById('modulo-select');
                        select.innerHTML = '<option value="">Seleccione un módulo</option>';
                        modulos.forEach(modulo => {
                            const option = document.createElement('option');
                            option.value = modulo.id;
                            option.textContent = modulo.nombre;
                            select.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error cargando módulos:', error);
                        alert('Error cargando módulos: ' + error.message);
                    });
                }
            } else {
                console.error('Sección no encontrada:', sectionId);
            }
        }

        // Función para cargar los permisos de un perfil
        async function loadPerfilPermisos() {
            console.log('Cargando permisos del perfil...');
            const perfilId = document.getElementById('perfil-select').value;
            const moduloId = document.getElementById('modulo-select').value;
            
            if (!perfilId || !moduloId) {
                console.log('Se requiere seleccionar perfil y módulo');
                document.getElementById('permisos-assignment').style.display = 'none';
                return;
            }

            // Mostrar el contenedor de permisos
            document.getElementById('permisos-assignment').style.display = 'block';

            // Generar los checkboxes de permisos CRUD
            const crudPermissions = [
                {id: '2', nombre: 'Crear', descripcion: 'Permite crear nuevos registros', icon: 'bi-plus-circle'},
                {id: '1', nombre: 'Ver', descripcion: 'Permite ver y consultar registros', icon: 'bi-eye'},
                {id: '3', nombre: 'Modificar', descripcion: 'Permite modificar registros existentes', icon: 'bi-pencil'},
                {id: '4', nombre: 'Eliminar', descripcion: 'Permite eliminar registros', icon: 'bi-trash'}
            ];

            const permissionsContainer = document.getElementById('crud-permissions');
            permissionsContainer.innerHTML = '';

            crudPermissions.forEach(permiso => {
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" value="${permiso.id}" id="permiso-${permiso.id}">
                    <label class="form-check-label" for="permiso-${permiso.id}">
                        <i class="bi ${permiso.icon} me-2"></i>${permiso.nombre}
                        <small class="text-muted d-block">${permiso.descripcion}</small>
                    </label>
                `;
                permissionsContainer.appendChild(div);
            });

            try {
                const response = await fetch('api_permisos.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'get_permisos',
                        usuario_id: perfilId,
                        modulo_id: moduloId
                    })
                });
                
                const result = await response.json();
                console.log('Permisos cargados:', result);
                
                // Marcar los permisos que tiene el perfil
                if (result && result.length > 0) {
                    result.forEach(permiso => {
                        const checkbox = document.querySelector(`#crud-permissions input[value="${permiso}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
            } catch (error) {
                console.error('Error cargando permisos:', error);
                alert('Error cargando permisos: ' + error.message);
            }
        }

        // Función para cargar la tabla de perfiles
        async function loadPerfiles() {
            console.log('Cargando tabla de perfiles...');
            try {
                const response = await fetch('api_permisos.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'get_perfiles'
                    })
                });
                
                const perfiles = await response.json();
                console.log('Perfiles cargados:', perfiles);
                
                const tbody = document.getElementById('perfiles-table');
                tbody.innerHTML = '';
                
                if (perfiles.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay perfiles registrados</td></tr>';
                    return;
                }
                
                perfiles.forEach(perfil => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${perfil.id}</td>
                        <td>${perfil.usuario}</td>
                        <td>${perfil.email}</td>
                        <td>${perfil.cargo}</td>
                        <td>
                            <span class="badge ${perfil.activo == 1 ? 'bg-success' : 'bg-danger'}">
                                ${perfil.activo == 1 ? 'Activo' : 'Inactivo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editPerfil(${perfil.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deletePerfil(${perfil.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error cargando perfiles:', error);
                alert('Error cargando perfiles: ' + error.message);
            }
        }

        // Función para guardar permisos
        async function savePerfilPermisos() {
            console.log('Iniciando savePerfilPermisos...');
            
            const perfilId = parseInt(document.getElementById('perfil-select').value);
            const moduloId = parseInt(document.getElementById('modulo-select').value);
            
            console.log('perfilId:', perfilId);
            console.log('moduloId:', moduloId);
            
            if (!perfilId || !moduloId) {
                alert('Debe seleccionar un perfil y un módulo');
                return;
            }

            const checkboxes = document.querySelectorAll('#crud-permissions input[type="checkbox"]');
            console.log('Checkboxes encontrados:', checkboxes.length);
            
            const selectedPermisos = [];

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    console.log('Checkbox marcado:', cb.value);
                    // Asegurarnos de que el valor sea un número
                    const permisoId = parseInt(cb.value);
                    if (!isNaN(permisoId)) {
                        selectedPermisos.push(permisoId);
                    }
                }
            });

            console.log('Permisos seleccionados:', selectedPermisos);

            if (selectedPermisos.length === 0) {
                alert('Debe seleccionar al menos un permiso');
                return;
            }

            try {
                const dataToSend = {
                    action: 'save_permisos',
                    id_usuario: perfilId,
                    id_modulo: moduloId,
                    id_permisos: selectedPermisos
                };

                console.log('Enviando datos:', dataToSend);

                const response = await fetch('api_permisos.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(dataToSend)
                });
                
                console.log('Respuesta recibida');
                const result = await response.json();
                console.log('Resultado:', result);

                if (result.success) {
                    alert('Permisos guardados correctamente en la base de datos');
                    // Recargar los permisos para mostrar los cambios
                    loadPerfilPermisos();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión: ' + error.message);
            }
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado');
            
            // Cargar perfiles iniciales
            loadPerfiles();
            
            // Agregar el event listener al botón
            const saveButton = document.getElementById('savePermisosBtn');
            if (saveButton) {
                console.log('Botón encontrado');
                saveButton.addEventListener('click', function() {
                    console.log('Botón clickeado');
                    savePerfilPermisos();
                });
            } else {
                console.error('Botón no encontrado');
            }
        });
    </script>
</body>
</html>